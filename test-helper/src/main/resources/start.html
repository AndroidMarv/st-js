<html>
<head>
<script>
	var id = -1;
	var count = 0;
	var lastTestSrc = null;
	var logDiv, statusDiv;
	var testId = 0;

	function retrieve() {
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {
				if (xmlhttp.readyState == 4) {
					try{
						if (xmlhttp.status == 200) {
							var response = eval("(" + xmlhttp.responseText + ")");
							id = response.id;
							statusDiv.innerHTML = xmlhttp.responseText + (++count);
							if (response.src != null && response.src != lastTestSrc) {
								testId = response.testId;
								logDiv.innerHTML += "<br>Executing:" + response.src;
								document.getElementById("iframe").src = response.src;
								lastTestSrc = response.src;
							}
						} else {
							statusDiv.innerHTML = "Error:" + xmlhttp.status;
						}
					} catch(ex){
						console.error("error:" + ex);
					}
					setTimeout(retrieve, 2000);

			}
		}
		try {
			xmlhttp.open("GET", "/check?id=" + id, true);
			xmlhttp.send();
		} catch (ex) {
			console.error("error:" + ex);
			setTimeout(retrieve, 2000);
		}
	}


	function sendError(method, ex){
		if (ex != "OK") {
			console.error(ex);
			//console.error(stacktrace());
		}
		logDiv.innerHTML += "<br>Result:" + ex;
		var xmlhttp = new XMLHttpRequest();
		try {
			var result = ex.message || ex;
			xmlhttp.open("POST", "/result?id=" + id + "&result=" + result + "&testId=" + testId + "&method=" + method + "&location=" + ex.location, true);
			xmlhttp.send();
		} catch (ex) {
			console.error("error:" + ex);
		}
	}
	function sendOK(method){
		sendError(method, "OK");
	}
	onload = function() {
		logDiv = document.getElementById("log");
		statusDiv = document.getElementById("status");
		retrieve();
	}
</script>
</head>
<body>
	STJS
	<div id="status"></div>
	<div id="log"></div>
	<iframe id="iframe" src="about:blank" width=600 height=300></iframe>
</body>
</html>