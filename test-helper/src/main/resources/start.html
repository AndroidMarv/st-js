<html>
<head>
<script>
	var id = -1;
	var count = 0;
	var lastTestSrc = null;
	var logDiv, statusDiv;
	var testId = 0;
	var timeout = 100;
	var waitResult = false;

	function status(s){
		statusDiv.innerHTML = "STJS Error:" + s;
	}

	function log(s){
		logDiv.innerHTML += new Date().toLocaleTimeString() + " " + s + "<br>";
	}
	function retrieve() {
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4) {
				try{
					if (xmlhttp.status == 200) {
						var response = eval("(" + xmlhttp.responseText + ")");
						id = response.id;
						status(xmlhttp.responseText + (++count));
						if (response.src != null && response.src != lastTestSrc) {
							testId = response.testId;
							log("Executing:" + response.src);
							waitResult = true;
							document.getElementById("iframe").src = response.src;
							lastTestSrc = response.src;
						}
					} else {
						status(xmlhttp.status);
					}
				} catch(ex){
					console.error("error:" + ex);
				}
				if (xmlhttp.status != 0)
					timeout = 100;
				if (!waitResult)
					setTimeout(retrieve, timeout);
			}
		}
		try {
			xmlhttp.open("GET", "/check?id=" + id, true);
			xmlhttp.send();
		} catch (ex) {
			console.error("error:" + ex);
			timeout = 2000;
			setTimeout(retrieve, timeout);
		}
	}


	function sendError(method, ex){
		if (ex != "OK") {
			console.error(ex);
			//console.error(stacktrace());
		}
		log("Result:" + ex);
		var xmlhttp = new XMLHttpRequest();
		try {
			var result = ex.message || ex;
			xmlhttp.open("POST", "/result?id=" + id + "&result=" + result + "&testId=" + testId + "&method=" + method + "&location=" + ex.location, true);
			xmlhttp.send();
		} catch (ex) {
			console.error("error:" + ex);
		}
		setTimeout(retrieve, timeout);
	}
	function sendOK(method){
		sendError(method, "OK");
	}
	onload = function() {
		logDiv = document.getElementById("log");
		statusDiv = document.getElementById("status");
		retrieve();
	}
</script>
<style>
	#status {
		border-bottom: solid 1px #ccc;
		padding-bottom: 5px;
	}
	#iframe {
		float:left;
	}
	#log {
		float:left;
		width:400px;
		padding-left: 20px;
	}
</style>
</head>
<body>
	<div id="status"></div>
	<iframe id="iframe" src="about:blank" width=600 height=400></iframe>
	<div id="log"></div>
</body>
</html>